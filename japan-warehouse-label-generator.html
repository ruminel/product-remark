<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¥æœ¬ä»“æ ‡ç­¾æ•°æ®ç”Ÿæˆ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        h1, h2 {
            color: #333;
        }
        
        textarea {
            width: 100%;
            height: 150px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            resize: vertical;
        }
        
        input[type="text"] {
            width: 300px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-right: 10px;
        }
        
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        
        button:hover {
            background-color: #0056b3;
        }
        
        .error-section {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 15px;
            border-radius: 4px;
            margin-top: 20px;
        }
        
        .error-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        
        .error-table th, .error-table td {
            border: 1px solid #f5c6cb;
            padding: 8px;
            text-align: left;
        }
        
        .error-table th {
            background-color: #f1b0b7;
        }
        
        .success-message {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            border-radius: 4px;
            margin-top: 20px;
        }
        .section {
            margin-bottom: 30px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        .copy-btn {
					background: none;
					border: none;
					cursor: pointer;
					font-size: 16px;
					padding: 2px 5px;
					border-radius: 3px;
			}

			.copy-btn:hover {
					background-color: #f0f0f0;
			}
    </style>
</head>
<body>
    <div class="container">
        <h1>æ—¥æœ¬ä»“æ ‡ç­¾æ•°æ®ç”Ÿæˆ</h1>
        
        <div class="section">
            <label for="orderNumber">è®¢å•å·:</label>
            <input type="text" id="orderNumber" placeholder="è¯·è¾“å…¥è®¢å•å·">
        </div>
        
        <div class="section">
            <label for="textInput">æ–‡æœ¬æ•°æ®:ä»SKUåˆ—åˆ°æ•°é‡åˆ—</label>
            <textarea id="textInput" placeholder="è¯·ç²˜è´´æ‚¨çš„æ–‡æœ¬æ•°æ®ï¼Œä¾‹å¦‚ï¼š&#10;SKU001	1234567890123	äº§å“A	image.jpg	çº¢è‰²	M	10&#10;SKU002	1234567890124	äº§å“B	image2.jpg	è“è‰²	L	5"></textarea>
        </div>
        
        <button onclick="processData()">å¤„ç†æ•°æ®å¹¶ç”Ÿæˆæ–‡ä»¶</button>
    </div>
	
    <div id="results"></div>
    <div id="success"></div>


    <script>
        function preprocessText(text) {
            const lines = text.split('\n');
            
            let result = [];
            let buffer = [];
            let inQuotes = false;
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const trimmedLine = line.trim();
                
                if (trimmedLine === '') continue;
                
                // æ£€æŸ¥å¼•å·çŠ¶æ€
                let quoteBalance = 0;
                let escaped = false;
                
                for (let j = 0; j < line.length; j++) {
                    const char = line[j];
                    
                    if (char === '\\' && !escaped) {
                        escaped = true;
                        continue;
                    }
                    
                    if (char === '"' && !escaped) {
                        quoteBalance++;
                    }
                    
                    escaped = false;
                }
                
                if (!inQuotes) {
                    // ä¸åœ¨å¼•å·å†…
                    if (quoteBalance % 2 === 1) {
                        // å¥‡æ•°ä¸ªå¼•å·ï¼Œå¼€å§‹å¼•å·åŒºåŸŸ
                        buffer.push(line);
                        inQuotes = true;
                    } else {
                        // æ­£å¸¸è¡Œ
                        result.push(line);
                    }
                } else {
                    // åœ¨å¼•å·å†…ï¼Œæ·»åŠ è¡Œåˆ°ç¼“å†²åŒº
                    buffer.push(line.trim());
                    
                    if (quoteBalance % 2 === 1) {
                        // é‡åˆ°ç»“æŸå¼•å·
                        const mergedLine = buffer.join(' ');
                        result.push(mergedLine);
                        buffer = [];
                        inQuotes = false;
                    }
                }
            }
            
            // å¤„ç†ç¼“å†²åŒºä¸­å‰©ä½™çš„å†…å®¹
            if (buffer.length > 0) {
                result.push(buffer.join(' '));
            }
            
            return result.join('\n');
        }
        function processData() {
            const orderNumber = document.getElementById('orderNumber').value.trim();
            const textInput = document.getElementById('textInput').value.trim();
            
            if (!orderNumber) {
                alert('è¯·è¾“å…¥è®¢å•å·ï¼');
                return;
            }
            
            if (!textInput) {
                alert('è¯·è¾“å…¥æ–‡æœ¬æ•°æ®ï¼');
                return;
            }
            
            // æ¸…ç©ºä¹‹å‰çš„ç»“æœ
            document.getElementById('results').innerHTML = '';
            document.getElementById('success').innerHTML = '';
            
            try {
                // é¢„å¤„ç†æ–‡æœ¬ï¼Œä¿®å¤è¢«æ„å¤–æ–­å¼€çš„è¡Œ
                const repairedText = preprocessText(textInput);
                // è§£ææ–‡æœ¬æ•°æ®ä¸ºäºŒç»´æ•°ç»„
                const rows = parseTextToTable(repairedText);
                
                // éªŒè¯åˆ—æ•°å¹¶è®°å½•ä¸è¶³çš„è¡Œ
                const insufficientRows = validateRowLength(rows);
                
                // æŒ‰å¤åˆé”®æ•´ç†æ•°æ®ï¼Œè®°å½•å†²çªçš„è¡Œ
                const { validRows, duplicateRows } = organizeByCompositeKey(rows);
                
                // å¦‚æœæœ‰æœ‰æ•ˆæ•°æ®ï¼Œç”Ÿæˆæ–‡ä»¶
                if (validRows.length > 0) {
                    const fileContent = generateLine(validRows, orderNumber);
                    showSuccessMessage(fileContent, validRows.length);
                } else {
                    alert('æ²¡æœ‰æœ‰æ•ˆçš„æ•°æ®å¯ä»¥ç”Ÿæˆæ–‡ä»¶ï¼');
                }
                // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                displayErrors(insufficientRows, duplicateRows, rows);
            } catch (error) {
                alert('å¤„ç†æ•°æ®æ—¶å‡ºç°é”™è¯¯ï¼š' + error.message);
            }
        }
        
        function parseTextToTable(text) {
            const lines = text.split('\n').filter(line => line.trim() !== '');
            const rows = [];
            
            for (let i = 0; i < lines.length; i++) {
                // ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼åˆ†å‰²åˆ¶è¡¨ç¬¦
                const columns = lines[i].replaceAll('"','').split('\t')
                .map(col => col.trim());
                rows.push(columns);
            }
            
            return rows;
        }
        
        function validateRowLength(rows) {
            const insufficientRows = [];
            const expectedColumns = ['sku', 'æ¡å½¢ç æ–‡æœ¬', 'äº§å“åç§°', 'äº§å“å›¾ç‰‡', 'è§„æ ¼1', 'è§„æ ¼2', 'æ•°é‡'];
            
            for (let i = 0; i < rows.length; i++) {
                if (rows[i].length < expectedColumns.length) {
                    insufficientRows.push({
                        rowIndex: i + 1,
                        rowData: rows[i],
                        actualColumns: rows[i].length,
                        expectedColumns: expectedColumns.length
                    });
                }
            }
            
            return insufficientRows;
        }
        
        function organizeByCompositeKey(rows) {
            const validRows = [];
            const duplicateRows = [];
            const seenKeys = new Set();
            
            // è·³è¿‡æ ‡é¢˜è¡Œï¼ˆå¦‚æœç¬¬ä¸€è¡Œçœ‹èµ·æ¥åƒæ ‡é¢˜ï¼‰
            const startIndex = (rows.length > 0 && 
                rows[0][0].toLowerCase().includes('sku') && 
                rows[0][1].toLowerCase().includes('æ¡å½¢ç ')) ? 1 : 0;
            
            for (let i = startIndex; i < rows.length; i++) {
                const row = rows[i];
                
                // ç¡®ä¿è¡Œæœ‰è¶³å¤Ÿçš„åˆ—
                if (row.length >= 7) {
                    const sku = row[0];
                    const barcode = row[1];
                    const key = `${sku}_${barcode}`;
                    
                    if (seenKeys.has(key)) {
                        duplicateRows.push({
                            rowIndex: i + 1,
                            rowData: row,
                            sku: sku,
                            barcode: barcode
                        });
                    } else {
                        seenKeys.add(key);
                        validRows.push(row);
                    }
                }
            }
            
            return { validRows, duplicateRows };
        }
        
        function displayErrors(insufficientRows, duplicateRows, allRows) {
            const resultsDiv = document.getElementById('results');
            let hasErrors = false;
            let errorHtml = '<div class="container"><h2>æœªå¤„ç†çš„è¡Œä¿¡æ¯</h2>';
            
            // æ˜¾ç¤ºåˆ—æ•°ä¸è¶³çš„è¡Œ
            if (insufficientRows.length > 0) {
                hasErrors = true;
                errorHtml += `
                    <div class="error-section">
                        <h3>åˆ—æ•°ä¸è¶³çš„è¡Œ (å…±${insufficientRows.length}è¡Œ)</h3>
                        <p>ä»¥ä¸‹è¡Œçš„åˆ—æ•°å°‘äºè¦æ±‚çš„7åˆ—ï¼Œå·²è·³è¿‡å¤„ç†ï¼š</p>
                        <table class="error-table">
                            <thead>
                                <tr>
                                    <th>è¡Œå·</th>
                                    <th>å®é™…åˆ—æ•°</th>
                                    <th>æœŸæœ›åˆ—æ•°</th>
                                    <th>è¡Œå†…å®¹</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                insufficientRows.forEach(item => {
                    errorHtml += `
                        <tr>
                            <td>${item.rowIndex}</td>
                            <td>${item.actualColumns}</td>
                            <td>${item.expectedColumns}</td>
                            <td>${item.rowData.join(' | ')}</td>
                        </tr>
                    `;
                });
                
                errorHtml += '</tbody></table></div>';
            }
            
            // æ˜¾ç¤ºå¤åˆé”®å†²çªçš„è¡Œ
            if (duplicateRows.length > 0) {
                hasErrors = true;
                errorHtml += `
                    <div class="error-section">
                        <h3>å¤åˆé”®å†²çªçš„è¡Œ (å…±${duplicateRows.length}è¡Œ)</h3>
                        <p>ä»¥ä¸‹è¡Œçš„SKUå’Œæ¡å½¢ç ç»„åˆé‡å¤ï¼Œå·²è·³è¿‡å¤„ç†ï¼š</p>
                        <table class="error-table">
                            <thead>
                                <tr>
                                    <th>è¡Œå·</th>
                                    <th>SKU</th>
                                    <th>æ¡å½¢ç </th>
                                    <th>è¡Œå†…å®¹</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                duplicateRows.forEach(item => {
                    errorHtml += `
                        <tr>
                            <td>${item.rowIndex}</td>
                            <td>${item.sku}</td>
                            <td>${item.barcode}</td>
                            <td>${item.rowData.join(' | ')}</td>
                        </tr>
                    `;
                });
                
                errorHtml += '</tbody></table></div>';
            }
            
            // å¦‚æœæ²¡æœ‰é”™è¯¯ï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯
            if (!hasErrors) {
                errorHtml += `
                    <div style="background-color: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; padding: 15px; border-radius: 4px;">
                        <h3>âœ“ æ‰€æœ‰è¡Œæ•°æ®æ ¼å¼æ­£ç¡®</h3>
                        <p>æ²¡æœ‰å‘ç°éœ€è¦è·³è¿‡çš„è¡Œã€‚</p>
                    </div>
                `;
            }
            
            errorHtml += '</div>';
            resultsDiv.innerHTML = errorHtml;
        }
        
        function generateLine(validRows, orderNumber) {
            const lines = [];
            
            // æ·»åŠ æ ‡é¢˜è¡Œ
            lines.push('FNSKU\tè¯´æ˜æ–‡æœ¬\tç®±å¤–æ–‡æœ¬\tå•†å“å\tå•†å“å-1\tå•†å“æ•°é‡');
            
            // ä¸ºæ¯ä¸€è¡Œç”Ÿæˆä¿¡æ¯é¡µå’Œæ ‡ç­¾é¡µ
            validRows.forEach(row => {
                const sku = row[0];
                const barcode = row[1];
                const productName = row[2];
                const spec1 = row[4] || '';
                const spec2 = row[5] || '';
                const quantity = row[6] || '';
                
                // ç»„åˆäº§å“è§„æ ¼
                const productSpec = [spec1, spec2].filter(item => item !== '').join('|');
                
                // ç”Ÿæˆä¿¡æ¯é¡µ
                const infoPage = `\t${orderNumber}\t\t${sku}_${barcode}_${quantity}ä»¶\t${productName}: ${productSpec}\t1`;
                
                // ç”Ÿæˆæ ‡ç­¾é¡µ
                const tabPage = `${barcode}\t${barcode}\t\t${sku}\t${sku}\t${quantity}`;
                
                lines.push(infoPage);
                lines.push(tabPage);
            });
            // åˆ›å»ºæ–‡æœ¬å†…å®¹
            const fileContent = lines.join('\n');
            return fileContent;
            // åˆ›å»ºBlobå¹¶ä¸‹è½½
            const blob = new Blob([fileContent], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `${orderNumber} æ ‡ç­¾ä¿¡æ¯.txt`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }
        
        function showSuccessMessage(fileContent, validRowCount) {
            const resultsDiv = document.getElementById('success');
            const successHtml = `
                <div class="copyable-group container" style="position: relative;">
										<h3>âœ“ æ‰“å°ç”¨æ•°æ®</h3>
										<p>æˆåŠŸå¤„ç†äº† ${validRowCount} è¡Œæœ‰æ•ˆæ•°æ®ã€‚</p>
                    <textarea class="success-message" readonly></textarea>
                    <label for="copy-btn">ç‚¹å‡»å¤åˆ¶
											<button class="copy-btn" id="copy-btn" title="ç‚¹å‡»å¤åˆ¶">ğŸ“‹</button>
                    </label>
                    <div id="copyTip" style="position: absolute; top: -30px; left: 0; background: #4CAF50; color: white; padding: 5px 10px; border-radius: 3px; font-size: 12px; opacity: 0; transition: opacity 0.3s;">å·²å¤åˆ¶!</div>
                </div>
            `;
            resultsDiv.innerHTML += successHtml;
            const sucessArea = resultsDiv.querySelector('.success-message')
            if(sucessArea){sucessArea.value = fileContent;}
        }
        document.getElementById('success').addEventListener('click', function(e) {
						if (e.target.closest('#copy-btn')) {
								const resultsDiv = document.getElementById('success');
								const copyText = resultsDiv.querySelector('.success-message')?.value;
								copyToClipboard(copyText);
								showCopyFeedback(e.target);
						}
				});
				function copyToClipboard(text) {
						// ç°ä»£æµè§ˆå™¨æ–¹æ³•
						if (navigator.clipboard && window.isSecureContext) {
								navigator.clipboard.writeText(text).then(() => {
										console.log('å¤åˆ¶æˆåŠŸ');
								}).catch(err => {
										console.error('å¤åˆ¶å¤±è´¥:', err);
										fallbackCopy(text);
								});
						} else {
								fallbackCopy(text);
						}
				}

				function fallbackCopy(text) {
						// å…¼å®¹æ—§æµè§ˆå™¨çš„å¤‡ç”¨æ–¹æ³•
						const textArea = document.createElement('textarea');
						textArea.value = text;
						textArea.style.position = 'fixed';
						textArea.style.opacity = '0';
						document.body.appendChild(textArea);
						textArea.select();
						
						try {
								document.execCommand('copy');
								console.log('å¤åˆ¶æˆåŠŸ');
						} catch (err) {
								console.error('å¤åˆ¶å¤±è´¥:', err);
						}
						
						document.body.removeChild(textArea);
				}

				function showCopyFeedback(element) {
					const tip = document.getElementById('copyTip');
					// æ˜¾ç¤ºæç¤º
					tip.style.opacity = '1';
					
					// 2ç§’åéšè—
					setTimeout(() => {
						tip.style.opacity = '0';
					}, 2000);
				}
    </script>
</body>
</html>
